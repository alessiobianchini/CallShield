# iOS build on Azure DevOps (equivalent to GitHub Actions workflow)
# Configure pipeline variables (Library â†’ Variable groups or pipeline vars) for secrets:
# IOS_CERT_P12 (base64), IOS_PROVISION_PROFILE (base64), IOS_CERT_PASSWORD, KEYCHAIN_PASSWORD,
# APPLE_TEAM_ID, BUNDLE_ID, APPLE_APP_STORE_CONNECT_KEY_ID, APPLE_APP_STORE_CONNECT_ISSUER_ID, APPLE_APP_STORE_CONNECT_KEY
# BASE_URL, FUNCTION_KEY for API env (used by babel transform-inline-environment-variables).
# Run on macOS hosted agents.

trigger: none
pr: none

pool:
  vmImage: 'macOS-latest'

variables:
  NODE_VERSION: '20'
  WORKING_DIRECTORY: '.'
  IOS_WORKSPACE: 'ios/callshieldnative.xcworkspace'
  IOS_SCHEME: 'callshieldnative'
  ARCHIVE_PATH: 'build/CallShield.xcarchive'
  EXPORT_PATH: 'build/ipa'

stages:
  - stage: ios
    displayName: Build iOS
    jobs:
      - job: build_ios
        displayName: Archive + Export IPA
        steps:
          - checkout: self
            clean: "true"

          - task: NodeTool@0
            inputs:
              versionSpec: '$(NODE_VERSION)'

          - bash: |
              set -euo pipefail
              npm install -g pnpm
              corepack enable
              corepack prepare pnpm@9 --activate
              pnpm --version
            displayName: Install pnpm

          - bash: |
              set -euo pipefail
              pnpm install --no-frozen-lockfile
            workingDirectory: $(WORKING_DIRECTORY)
            displayName: Install JS deps

          - task: Cache@2
            inputs:
              key: 'pods | "$(Agent.OS)" | $(Build.SourcesDirectory)/ios/Podfile.lock'
              restoreKeys: |
                pods | "$(Agent.OS)"
              path: |
                $(HOME)/Library/Caches/CocoaPods
                $(HOME)/.cocoapods
            displayName: Cache CocoaPods

          - bash: |
              set -euo pipefail
              cd ios
              pod --version
              pod install --repo-update || { rm -rf Pods; pod cache clean --all || true; pod install --repo-update; }
            workingDirectory: $(WORKING_DIRECTORY)
            displayName: Install CocoaPods

          - bash: |
              set -euo pipefail
              for v in IOS_CERT_P12 IOS_PROVISION_PROFILE KEYCHAIN_PASSWORD IOS_CERT_PASSWORD APPLE_TEAM_ID BUNDLE_ID APPLE_APP_STORE_CONNECT_KEY_ID APPLE_APP_STORE_CONNECT_ISSUER_ID APPLE_APP_STORE_CONNECT_KEY; do
                if [ -z "${!v:-}" ]; then
                  echo "Missing or empty: $v"
                  exit 1
                fi
              done
            env:
              IOS_CERT_P12: $(IOS_CERT_P12)
              IOS_PROVISION_PROFILE: $(IOS_PROVISION_PROFILE)
              KEYCHAIN_PASSWORD: $(KEYCHAIN_PASSWORD)
              IOS_CERT_PASSWORD: $(IOS_CERT_PASSWORD)
              APPLE_TEAM_ID: $(APPLE_TEAM_ID)
              BUNDLE_ID: $(BUNDLE_ID)
              APPLE_APP_STORE_CONNECT_KEY_ID: $(APPLE_APP_STORE_CONNECT_KEY_ID)
              APPLE_APP_STORE_CONNECT_ISSUER_ID: $(APPLE_APP_STORE_CONNECT_ISSUER_ID)
              APPLE_APP_STORE_CONNECT_KEY: $(APPLE_APP_STORE_CONNECT_KEY)
            displayName: Validate signing secrets

          - bash: |
              set -euo pipefail
              mkdir -p "$HOME/certs"
              printf '%s' "$IOS_CERT_P12" | tr -d '\n\r ' | base64 --decode > "$HOME/certs/dist.p12"
              printf '%s' "$IOS_PROVISION_PROFILE" | tr -d '\n\r ' | base64 --decode > "$HOME/certs/profile.mobileprovision"
              ls -l "$HOME/certs/dist.p12" "$HOME/certs/profile.mobileprovision"
            env:
              IOS_CERT_P12: $(IOS_CERT_P12)
              IOS_PROVISION_PROFILE: $(IOS_PROVISION_PROFILE)
            displayName: Decode cert & profile

          - bash: |
              set -euo pipefail
              openssl pkcs12 -in "$HOME/certs/dist.p12" -info -noout -passin pass:"$IOS_CERT_PASSWORD"
            env:
              IOS_CERT_PASSWORD: $(IOS_CERT_PASSWORD)
            displayName: Validate p12 password (metadata)

          - bash: |
              set -euo pipefail
              KEYCHAIN_PATH="$HOME/certs/app-signing.keychain-db"
              security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
              security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
              security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
              security list-keychains -d user -s "$KEYCHAIN_PATH"
              security default-keychain -d user -s "$KEYCHAIN_PATH"

              openssl pkcs12 -in "$HOME/certs/dist.p12" -clcerts -nokeys -passin pass:"$IOS_CERT_PASSWORD" -out "$HOME/certs/dist_cert.pem"
              openssl pkcs12 -in "$HOME/certs/dist.p12" -nocerts -nodes -passin pass:"$IOS_CERT_PASSWORD" -out "$HOME/certs/dist_key.pem"
              security import "$HOME/certs/dist_cert.pem" -k "$KEYCHAIN_PATH" -T /usr/bin/codesign -T /usr/bin/security
              security import "$HOME/certs/dist_key.pem"  -k "$KEYCHAIN_PATH" -T /usr/bin/codesign -T /usr/bin/security
              security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
              security find-identity -v -p codesigning "$KEYCHAIN_PATH" || true
              echo "KEYCHAIN_PATH=$KEYCHAIN_PATH" >> "$BASH_ENV"
            env:
              KEYCHAIN_PASSWORD: $(KEYCHAIN_PASSWORD)
              IOS_CERT_PASSWORD: $(IOS_CERT_PASSWORD)
            displayName: Create keychain & import cert/key

          - bash: |
              set -euo pipefail
              security cms -D -i "$HOME/certs/profile.mobileprovision" > "$HOME/certs/profile.plist"
              PROFILE_UUID=$(/usr/libexec/PlistBuddy -c 'Print :UUID' "$HOME/certs/profile.plist")
              PROFILE_NAME=$(/usr/libexec/PlistBuddy -c 'Print :Name' "$HOME/certs/profile.plist")
              mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"
              cp "$HOME/certs/profile.mobileprovision" "$HOME/Library/MobileDevice/Provisioning Profiles/$PROFILE_UUID.mobileprovision"
              echo "PROFILE_UUID=$PROFILE_UUID" >> "$BASH_ENV"
              echo "PROFILE_NAME=$PROFILE_NAME" >> "$BASH_ENV"
              echo "Profile: $PROFILE_NAME ($PROFILE_UUID)"
            displayName: Install provisioning profile

          - bash: |
              set -euo pipefail
              mkdir -p build
              IOS_WORKSPACE=$(find ios -maxdepth 2 -name "*.xcworkspace" | head -n 1)
              echo "Using workspace: $IOS_WORKSPACE"
              LOG="$BUILD_SOURCESDIRECTORY/xcodebuild-archive.log"

              xcodebuild \
                -workspace "$IOS_WORKSPACE" \
                -scheme "$(IOS_SCHEME)" \
                -configuration Release \
                -sdk iphoneos \
                -destination 'generic/platform=iOS' \
                -archivePath "$PWD/$(ARCHIVE_PATH)" \
                DEVELOPMENT_TEAM="$(APPLE_TEAM_ID)" \
                PRODUCT_BUNDLE_IDENTIFIER="$(BUNDLE_ID)" \
                CODE_SIGN_STYLE=Manual \
                CODE_SIGN_IDENTITY="Apple Distribution" \
                PROVISIONING_PROFILE_SPECIFIER="$PROFILE_NAME" \
                CODE_SIGN_KEYCHAIN="$KEYCHAIN_PATH" \
                OTHER_CODE_SIGN_FLAGS="--keychain $KEYCHAIN_PATH" \
                ASSETCATALOG_COMPILER_APPICON_NAME=AppIcon \
                ASSETCATALOG_COMPILER_INCLUDE_ALL_APPICON_ASSETS=YES \
                archive | tee "$LOG" | xcpretty
            env:
              APPLE_TEAM_ID: $(APPLE_TEAM_ID)
              BUNDLE_ID: $(BUNDLE_ID)
              IOS_SCHEME: $(IOS_SCHEME)
              ARCHIVE_PATH: $(ARCHIVE_PATH)
              KEYCHAIN_PATH: $(KEYCHAIN_PATH)
              PROFILE_NAME: $(PROFILE_NAME)
            displayName: Build (archive)

          - bash: |
              set -euo pipefail
              mkdir -p "$(EXPORT_PATH)"
              cat > exportOptions.plist <<EOF
              <?xml version="1.0" encoding="UTF-8"?>
              <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
              <plist version="1.0">
              <dict>
                <key>method</key><string>app-store-connect</string>
                <key>teamID</key><string>$(APPLE_TEAM_ID)</string>
                <key>signingStyle</key><string>manual</string>
                <key>signingCertificate</key><string>Apple Distribution</string>
                <key>provisioningProfiles</key>
                <dict>
                  <key>$(BUNDLE_ID)</key><string>$(PROFILE_NAME)</string>
                </dict>
                <key>compileBitcode</key><false/>
                <key>uploadSymbols</key><true/>
              </dict>
              </plist>
              EOF

              xcodebuild -exportArchive \
                -archivePath "$PWD/$(ARCHIVE_PATH)" \
                -exportOptionsPlist exportOptions.plist \
                -exportPath "$PWD/$(EXPORT_PATH)" | xcpretty
            env:
              APPLE_TEAM_ID: $(APPLE_TEAM_ID)
              BUNDLE_ID: $(BUNDLE_ID)
              PROFILE_NAME: $(PROFILE_NAME)
              ARCHIVE_PATH: $(ARCHIVE_PATH)
              EXPORT_PATH: $(EXPORT_PATH)
            displayName: Export IPA

          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: '$(System.DefaultWorkingDirectory)/$(EXPORT_PATH)'
              ArtifactName: 'ios-ipa'
              publishLocation: 'Container'
            displayName: Publish IPA artifact

          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: '$(System.DefaultWorkingDirectory)/$(ARCHIVE_PATH)'
              ArtifactName: 'ios-archive'
              publishLocation: 'Container'
            displayName: Publish xcarchive artifact
