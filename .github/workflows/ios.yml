name: iOS Build (React Native)

on:
  workflow_dispatch:

env:
  NODE_VERSION: "20"
  WORKING_DIRECTORY: .
  IOS_SCHEME: callshieldnative
  ARCHIVE_PATH: build/CallShield.xcarchive
  EXPORT_PATH: build/ipa
  BUILD_NUMBER: ${{ github.run_number }}

  # IMPORTANT: let setup-node cache find an existing dir
  PNPM_STORE_PATH: /Users/runner/.pnpm-store

  EXPO_PUBLIC_API_BASE_URL: ${{ secrets.BASE_URL }}
  EXPO_PUBLIC_FUNCTION_KEY: ${{ secrets.FUNCTION_KEY }}

jobs:
  build-ios:
    runs-on: macos-latest
    environment: IOS

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Enable corepack + pnpm
        shell: bash
        run: |
          set -euo pipefail
          corepack enable
          corepack prepare pnpm@9.15.3 --activate
          pnpm --version

      - name: Setup Node (pnpm cache)
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - name: Ensure pnpm store dir exists (fix post-cache error)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "${{ env.PNPM_STORE_PATH }}"
          pnpm config set store-dir "${{ env.PNPM_STORE_PATH }}"
          echo "pnpm store-dir: $(pnpm config get store-dir)"
          ls -la "${{ env.PNPM_STORE_PATH }}" || true

      - name: Install JS dependencies
        working-directory: ${{ env.WORKING_DIRECTORY }}
        shell: bash
        run: |
          set -euo pipefail
          pnpm install --no-frozen-lockfile

      - name: Ensure extension sources exist (Call Directory)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ios/CallShieldDirectory

      - name: Install XcodeGen
        shell: bash
        run: |
          set -euo pipefail
          brew update
          brew install xcodegen

      - name: Generate Xcode project (app + Call Directory extension)
        shell: bash
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          set -euo pipefail
          xcodegen generate --spec project.yml
          ls -la ios || true

      - name: Install CocoaPods
        working-directory: ${{ env.WORKING_DIRECTORY }}/ios
        shell: bash
        run: |
          set -euo pipefail
          sudo gem install cocoapods -N || true
          pod --version
          pod install --repo-update

      - name: Validate signing secrets
        shell: bash
        env:
          IOS_CERT_P12: ${{ secrets.IOS_CERT_P12 }}
          IOS_CERT_PASSWORD: ${{ secrets.IOS_CERT_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          BUNDLE_ID: ${{ secrets.BUNDLE_ID }}

          IOS_PROVISION_PROFILE_APP: ${{ secrets.IOS_PROVISION_PROFILE }}
          IOS_PROVISION_PROFILE_DIR: ${{ secrets.IOS_PROVISION_PROFILE_DIR }}

          APPLE_APP_STORE_CONNECT_KEY_ID: ${{ secrets.APPLE_APP_STORE_CONNECT_KEY_ID }}
          APPLE_APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APPLE_APP_STORE_CONNECT_ISSUER_ID }}
          APPLE_APP_STORE_CONNECT_KEY: ${{ secrets.APPLE_APP_STORE_CONNECT_KEY }}
        run: |
          set -euo pipefail
          for v in IOS_CERT_P12 IOS_CERT_PASSWORD KEYCHAIN_PASSWORD APPLE_TEAM_ID BUNDLE_ID IOS_PROVISION_PROFILE_APP IOS_PROVISION_PROFILE_DIR APPLE_APP_STORE_CONNECT_KEY_ID APPLE_APP_STORE_CONNECT_ISSUER_ID APPLE_APP_STORE_CONNECT_KEY; do
            if [ -z "${!v}" ]; then
              echo "Missing or empty: $v"
              exit 1
            fi
          done

      - name: Bump build number (CFBundleVersion)
        shell: bash
        env:
          BUILD_NUMBER: ${{ env.BUILD_NUMBER }}
        run: |
          set -euo pipefail
          PLIST="ios/callshieldnative/Info.plist"
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $BUILD_NUMBER" "$PLIST" || \
          /usr/libexec/PlistBuddy -c "Add :CFBundleVersion string $BUILD_NUMBER" "$PLIST"
          /usr/libexec/PlistBuddy -c "Print :CFBundleVersion" "$PLIST"

      - name: Decode certificate
        shell: bash
        env:
          IOS_CERT_P12: ${{ secrets.IOS_CERT_P12 }}
        run: |
          set -euo pipefail
          mkdir -p "$HOME/certs"
          printf '%s' "$IOS_CERT_P12" | tr -d '\n\r ' | base64 --decode > "$HOME/certs/dist.p12"
          ls -l "$HOME/certs/dist.p12"

      - name: Create keychain + import cert/key
        shell: bash
        env:
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
          IOS_CERT_PASSWORD: ${{ secrets.IOS_CERT_PASSWORD }}
        run: |
          set -euo pipefail
          KEYCHAIN_PATH="$HOME/certs/app-signing.keychain-db"

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychains -d user -s "$KEYCHAIN_PATH"
          security default-keychain -d user -s "$KEYCHAIN_PATH"

          openssl pkcs12 -in "$HOME/certs/dist.p12" -clcerts -nokeys \
            -passin pass:"$IOS_CERT_PASSWORD" -out "$HOME/certs/dist_cert.pem"

          openssl pkcs12 -in "$HOME/certs/dist.p12" -nocerts -nodes \
            -passin pass:"$IOS_CERT_PASSWORD" -out "$HOME/certs/dist_key.pem"

          security import "$HOME/certs/dist_cert.pem" -k "$KEYCHAIN_PATH" -T /usr/bin/codesign -T /usr/bin/security
          security import "$HOME/certs/dist_key.pem"  -k "$KEYCHAIN_PATH" -T /usr/bin/codesign -T /usr/bin/security
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          echo "KEYCHAIN_PATH=$KEYCHAIN_PATH" >> "$GITHUB_ENV"
          security find-identity -v -p codesigning "$KEYCHAIN_PATH" || true

      - name: Install provisioning profiles (app + extension) + extract PROFILE NAMES
        shell: bash
        env:
          IOS_PROVISION_PROFILE_APP: ${{ secrets.IOS_PROVISION_PROFILE }}
          IOS_PROVISION_PROFILE_DIR: ${{ secrets.IOS_PROVISION_PROFILE_DIR }}
        run: |
          set -euo pipefail
          mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"

          printf '%s' "$IOS_PROVISION_PROFILE_APP" | tr -d '\n\r ' | base64 --decode > "$HOME/certs/app.mobileprovision"
          printf '%s' "$IOS_PROVISION_PROFILE_DIR" | tr -d '\n\r ' | base64 --decode > "$HOME/certs/dir.mobileprovision"

          # decode -> plist
          security cms -D -i "$HOME/certs/app.mobileprovision" > "$HOME/certs/app.plist"
          security cms -D -i "$HOME/certs/dir.mobileprovision" > "$HOME/certs/dir.plist"

          APP_UUID=$(/usr/libexec/PlistBuddy -c 'Print :UUID' "$HOME/certs/app.plist")
          APP_NAME=$(/usr/libexec/PlistBuddy -c 'Print :Name' "$HOME/certs/app.plist")
          DIR_UUID=$(/usr/libexec/PlistBuddy -c 'Print :UUID' "$HOME/certs/dir.plist")
          DIR_NAME=$(/usr/libexec/PlistBuddy -c 'Print :Name' "$HOME/certs/dir.plist")

          cp "$HOME/certs/app.mobileprovision" "$HOME/Library/MobileDevice/Provisioning Profiles/$APP_UUID.mobileprovision"
          cp "$HOME/certs/dir.mobileprovision" "$HOME/Library/MobileDevice/Provisioning Profiles/$DIR_UUID.mobileprovision"

          echo "PROFILE_NAME=$APP_NAME" >> "$GITHUB_ENV"
          echo "PROFILE_DIR_NAME=$DIR_NAME" >> "$GITHUB_ENV"

          echo "App profile: $APP_NAME ($APP_UUID)"
          echo "Dir profile: $DIR_NAME ($DIR_UUID)"

      - name: Build iOS (archive) - ensure extension is embedded
        working-directory: ${{ env.WORKING_DIRECTORY }}
        shell: bash
        env:
          DEVELOPMENT_TEAM: ${{ secrets.APPLE_TEAM_ID }}
          BUNDLE_ID: ${{ secrets.BUNDLE_ID }}
        run: |
          set -euo pipefail
          mkdir -p build
          IOS_WORKSPACE=$(find ios -maxdepth 2 -name "*.xcworkspace" | head -n 1)
          echo "Using workspace: $IOS_WORKSPACE"

          EXT_BUNDLE_ID="${BUNDLE_ID}.CallShieldDirectory"

          xcodebuild \
            -workspace "$IOS_WORKSPACE" \
            -scheme "${{ env.IOS_SCHEME }}" \
            -configuration Release \
            -sdk iphoneos \
            -destination 'generic/platform=iOS' \
            -archivePath "$PWD/${{ env.ARCHIVE_PATH }}" \
            DEVELOPMENT_TEAM="$DEVELOPMENT_TEAM" \
            CODE_SIGN_STYLE=Manual \
            CODE_SIGN_IDENTITY="Apple Distribution" \
            PROVISIONING_PROFILE_SPECIFIER="$PROFILE_NAME" \
            PROVISIONING_PROFILE_SPECIFIER[CallShieldDirectory]="$PROFILE_DIR_NAME" \
            PRODUCT_BUNDLE_IDENTIFIER="$BUNDLE_ID" \
            PRODUCT_BUNDLE_IDENTIFIER[CallShieldDirectory]="$EXT_BUNDLE_ID" \
            CODE_SIGN_KEYCHAIN="$KEYCHAIN_PATH" \
            OTHER_CODE_SIGN_FLAGS="--keychain $KEYCHAIN_PATH" \
            CURRENT_PROJECT_VERSION="${{ env.BUILD_NUMBER }}" \
            archive

          echo "== Check embedded extension in archive =="
          find "${{ env.ARCHIVE_PATH }}/Products/Applications" -maxdepth 4 -name "*.appex" -print || true

      - name: Export IPA (App Store / TestFlight)
        working-directory: ${{ env.WORKING_DIRECTORY }}
        shell: bash
        env:
          BUNDLE_ID: ${{ secrets.BUNDLE_ID }}
        run: |
          set -euo pipefail
          mkdir -p "${{ env.EXPORT_PATH }}"
          EXT_BUNDLE_ID="${BUNDLE_ID}.CallShieldDirectory"

          cat > exportOptions.plist <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key><string>app-store</string>
            <key>teamID</key><string>${{ secrets.APPLE_TEAM_ID }}</string>
            <key>signingStyle</key><string>manual</string>
            <key>signingCertificate</key><string>Apple Distribution</string>
            <key>provisioningProfiles</key>
            <dict>
              <key>${BUNDLE_ID}</key><string>${PROFILE_NAME}</string>
              <key>${EXT_BUNDLE_ID}</key><string>${PROFILE_DIR_NAME}</string>
            </dict>
            <key>uploadSymbols</key><true/>
            <key>compileBitcode</key><false/>
          </dict>
          </plist>
          EOF

          xcodebuild -exportArchive \
            -archivePath "$PWD/${{ env.ARCHIVE_PATH }}" \
            -exportOptionsPlist exportOptions.plist \
            -exportPath "$PWD/${{ env.EXPORT_PATH }}"

          echo "== Check embedded extension in IPA =="
          IPA_FILE="$(ls "${{ env.EXPORT_PATH }}"/*.ipa | head -1)"
          tmp="$(mktemp -d)"
          unzip -q "$IPA_FILE" -d "$tmp"
          find "$tmp/Payload" -maxdepth 5 -name "*.appex" -print || true

      - name: Create App Store Connect API key JSON
        shell: bash
        env:
          KEY_ID: ${{ secrets.APPLE_APP_STORE_CONNECT_KEY_ID }}
          ISSUER_ID: ${{ secrets.APPLE_APP_STORE_CONNECT_ISSUER_ID }}
          ASC_KEY: ${{ secrets.APPLE_APP_STORE_CONNECT_KEY }}
        run: |
          set -euo pipefail
          ASC_KEY_NORM="$(printf '%b' "$ASC_KEY")"
          jq -n \
            --arg key_id "$KEY_ID" \
            --arg issuer_id "$ISSUER_ID" \
            --arg key "$ASC_KEY_NORM" \
            '{key_id:$key_id, issuer_id:$issuer_id, key:$key}' \
            > api_key.json

      - name: Install fastlane
        shell: bash
        run: |
          set -euo pipefail
          sudo gem install fastlane -NV

      - name: Upload to TestFlight
        shell: bash
        env:
          APP_IDENTIFIER: ${{ secrets.BUNDLE_ID }}   # <-- MAIN app bundle id
        run: |
          set -euo pipefail

          IPA_FILE="$(ls "${{ env.EXPORT_PATH }}"/*.ipa | head -1 || true)"
          if [ -z "$IPA_FILE" ]; then
            echo "IPA not found in ${{ env.EXPORT_PATH }}"
            ls -la "${{ env.EXPORT_PATH }}" || true
            exit 1
          fi

          # usa bundle exec se hai Gemfile
          bundle exec fastlane pilot upload \
            --api_key_path api_key.json \
            --ipa "$IPA_FILE" \
            --app_identifier "$APP_IDENTIFIER" \
            --skip_waiting_for_build_processing true \
            --changelog "CI build"
            
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-build
          path: |
            ${{ env.ARCHIVE_PATH }}
            ${{ env.EXPORT_PATH }}

      - name: Cleanup (always)
        if: always()
        shell: bash
        run: |
          set +e
          security delete-keychain "$KEYCHAIN_PATH" 2>/dev/null || true
          rm -f api_key.json exportOptions.plist || true
